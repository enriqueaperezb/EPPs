@model IEnumerable<EPPs.Models.previoInventario>
@{
    ViewData["Title"] = "Registros";
    var codigo_emp = ViewBag.Codigo_emp as string ?? "";
}

<h1 class="mb-3">Registros</h1>

<form asp-action="Index" method="get" class="mb-3" role="search">
    <div style="display:flex; gap:.5rem; align-items:center;">
        <input type="text"
               name="codigo_emp"
               value="@codigo_emp"
               placeholder="Código del empleado..."
               class="form-control"
               style="max-width:320px;" />
        <button type="submit" class="btn btn-primary">Buscar</button>
        <a asp-action="Index" class="btn btn-outline-secondary">Limpiar</a>
    </div>
</form>

<div class="row">
    <div class="col-12 col-lg-7">
        <h5>Maestro</h5>
        <table id="tabla-maestro" class="table table-hover table-striped align-middle">
            <thead>
                <tr>
                    <th>Código</th>
                    <th>Empleado</th>
                    <th>Fecha</th>
                    <th>Observación</th>
                </tr>
            </thead>
            <tbody>
                @if (Model != null && Model.Any())
                {
                    foreach (var r in Model)
                    {
                        <tr class="fila-maestro" data-codigo_cpi="@r.Codigo" style="cursor:pointer;">
                            <td>@r.Codigo</td>
                            <td>@r.Empleado</td>
                            <td>@r.Fecha.ToString("yyyy-MM-dd")</td>
                            <td>@r.Observacion</td>
                        </tr>
                    }
                }
                else
                {
                    <tr><td colspan="4" class="text-center">Sin resultados</td></tr>
                }
            </tbody>
        </table>
    </div>

    <div class="col-12 col-lg-5">
        <h5>Detalle</h5>
        <div id="detalle-contenedor" class="border rounded p-2">
            <div class="text-muted">Selecciona un registro para ver el detalle…</div>
        </div>
    </div>
</div>

 @section Scripts {
<script>
(() => {
    const tabla = document.getElementById('tabla-maestro');
    const contenedorDetalle = document.getElementById('detalle-contenedor');
    let seleccionada;

    async function cargarDetalle(id) {
        // Mostrar un loader simple
        contenedorDetalle.innerHTML = '<div class="text-muted">Cargando detalle…</div>';
        try {
                const resp = await fetch(`@Url.Action("previoInventario_detalle", "Home")?codigo_cpi=${encodeURIComponent(id)}`, {
                method: 'GET',
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            });
            if (!resp.ok) throw new Error('Error al cargar detalle');
            const html = await resp.text();
            contenedorDetalle.innerHTML = html;
        } catch (err) {
            console.error(err);
            contenedorDetalle.innerHTML = '<div class="text-danger">No se pudo cargar el detalle.</div>';
        }
    }

    tabla?.addEventListener('click', (e) => {
        const tr = e.target.closest('tr.fila-maestro');
        if (!tr) return;
            const id = tr.getAttribute('data-codigo_cpi');
        if (!id) return;

        // Resaltar selección
        if (seleccionada) seleccionada.classList.remove('table-primary');
        tr.classList.add('table-primary');
        seleccionada = tr;

        // Cargar detalle
        cargarDetalle(id);
    });

    // (Opcional) Autoseleccionar la primera fila al cargar
    const primera = tabla?.querySelector('tbody tr.fila-maestro');
    if (primera) {
        primera.classList.add('table-primary');
        seleccionada = primera;
            const idIni = primera.getAttribute('data-codigo_cpi');
        if (idIni) cargarDetalle(idIni);
    }
})();
</script>
}